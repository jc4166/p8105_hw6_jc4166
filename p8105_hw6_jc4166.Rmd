---
title: "p8105_hw6_jc4166"
author: "Jerri Chen"
date: "11/21/2019"
output: github_document
---

```{r, include = FALSE, warning = FALSE, message = FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(knitr)
library(readxl)
library(haven)
library(plotly)
library(viridis)
library(modelr)
library(broom)
library(purrr)
library(mgcv)

set.seed(1)
```

## Problem 1
Read in and clean birthweight data.
```{r, include = FALSE, warning = FALSE, message = FALSE}
birthweight_data = read_csv(file = "./data/birthweight.csv") %>% 
  #clean variable names
  janitor::clean_names() %>% 
  #drop any missing data
  drop_na() %>% 
  #convert to factor variable where appropriate (babysex, frace, malform, mrace)
  mutate(babysex = as.factor(babysex),
         frace = as.factor(frace),
         malform = as.factor(malform),
         mrace = as.factor(mrace)
         ) %>% 
  mutate(babysex = recode(babysex,
        '1' = "male", 
        '2' = "female")
        ) %>% 
  mutate(mrace = recode(mrace,
        '1' = "white", 
        '2' = "black", 
        '3' = "asian", 
        '4' = "puerto rican",
        '8' = "other")
        ) %>% 
  mutate(frace = recode(frace,
        '1' = "white", 
        '2' = "black", 
        '3' = "asian", 
        '4' = "puerto rican",
        '8' = "other",
        '9' = "unknown")
        ) %>% 
  mutate(malform = recode(malform,
        '0' = "absent", 
        '1' = "present")
        ) %>% 
  mutate_if(is.numeric, round, 2)
```

### Propose a regression model for birthweight.
The ouctome is birthweight (bwt).  
The potential predictors (i.e. all the variables collected) are:  

Maternal Factors:  
- mrace: mother’s race  
- menarche: mother’s age at menarche  
- mheight: mother’s height  
- momage: mother’s age at delivery  
- ppbmi: mother’s pre-pregnancy BMI  
- ppwt: mother’s pre-pregnancy weight  

Pregnancy Factors:  
- gaweeks: gestational age in weeks  
- delwt: mother’s weight at delivery (pounds)  
- smoken: average number of cigarettes smoked per day during pregnancy  
- wtgain: mother’s weight gain during pregnancy  

Pregnancy History Factors:  
- parity: number of live births prior to this pregnancy  
- pnumlbw: previous number of low birth weight babies  
- pnumsga: number of prior small for gestational age babies  

Other Family Factors:  
- fincome: family monthly income   
- frace: father’s race  

Baby Factors:  
- malform: presence of malformations that could affect weight  

Based on my experience as a clinician, I propose a model in which low birthweight can be predicted by gestational age in weeks, mother's smoking status, history of previous low birth weight babies, income, and presence of malformations that could affect weight.  

```{r, warning = FALSE, message = FALSE}
birthweight_model_1 = lm(bwt ~ gaweeks + smoken + pnumlbw + fincome + malform, data = birthweight_data)

birthweight_model_1 %>% 
  broom::tidy() %>% 
  select(term, estimate, p.value) %>% 
  knitr::kable(digits = 3, caption = "Regression Summary (Model 1)")
```

```{r, warning = FALSE, message = FALSE}
birthweight_data %>% 
  modelr::add_residuals(birthweight_model_1) %>%
  modelr::add_predictions(birthweight_model_1) %>% 
  ggplot(aes(x = pred, y = resid)) + 
    geom_point(alpha = 0.5) + 
    geom_hline(yintercept = 0, color = "blue") + 
    labs(
      title = "Model Residuals vs. Fitted Values",
      x = "Fitted Values",
      y = "Residuals"
   )
```

Compare your model to two others:  
Model 2: Using length at birth and gestational age as predictors (main effects only)  

```{r, warning = FALSE, message = FALSE} 
birthweight_model_2 = lm(bwt ~ gaweeks + blength, data = birthweight_data)

birthweight_model_2 %>% 
  broom::glance()  %>%
  knitr::kable(caption = "Regression Summary (Model 2)")
```

Model 3: Using head circumference, length, sex, and all interactions (including the three-way interaction) between these  
```{r, warning = FALSE, message = FALSE}
birthweight_model_3 = lm(bwt ~ bhead + blength + babysex + bhead * blength + bhead * babysex + blength * babysex + bhead * blength * babysex, data = birthweight_data)

birthweight_model_3 %>% 
  broom::glance()  %>%
  knitr::kable(caption = "Regression Summary (Model 3)")
```

Make the comparison in terms of the cross-validated prediction error; use crossv_mc and functions in purrr as appropriate.
```{r, warning = FALSE, message = FALSE}
cv_birthweight_models =
  crossv_mc(birthweight_data, 100) %>%
    mutate( 
      train = map(train, as_tibble),
      test = map(test, as_tibble)
    )
```

```{r, warning = FALSE, message = FALSE}
cv_birthweight_models = cv_birthweight_models %>%
  mutate(
      birthweight_model_1  = map(train, ~lm(bwt ~ gaweeks + bhead + blength + smoken + fincome + pnumlbw, data = .x)),
      birthweight_model_2  = map(train, ~lm(bwt ~ gaweeks + blength, data = .x)),
      birthweight_model_3  = map(train, ~lm(bwt ~ bhead + blength + babysex + bhead * blength + bhead * babysex + blength * babysex + bhead * blength * babysex, data = as_tibble(.x)))
      ) %>% 
    mutate(
      rmse_birthweight_model_1 = map2_dbl(birthweight_model_1, test, ~rmse(model = .x, data = .y)),
      rmse_birthweight_model_2   = map2_dbl(birthweight_model_2, test, ~rmse(model = .x, data = .y)),
      rmse_birthweight_model_3 = map2_dbl(birthweight_model_3, test, ~rmse(model = .x, data = .y))
      )
```

```{r, warning = FALSE, message = FALSE}
cv_birthweight_models %>% 
  select(starts_with("rmse")) %>% 
  pivot_longer(
    everything(),
    names_to = "model", 
    values_to = "rmse",
    names_prefix = "rmse_") %>% 
  mutate(model = fct_inorder(model)) %>% 
  ggplot(aes(x = model, y = rmse)) + 
    geom_violin(aes(fill = model, color = model)) +
    labs(
    title = "Distribution of RMSE Values (Regression Models 1, 2, 3)",
      x = "Regression Model",
      y = "RMSE")
```

Model 1 has the lowest prediction error of the three models (though model 3 is close).
